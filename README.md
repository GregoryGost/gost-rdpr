# GOST RDPR (Resolve Domain Per Record)

A utility for working with Mikrotik RouterOS and BGP protocol for announcing IP addresses.

The utility provides parsing of domain names into IP addresses, processing of domain lists and their subsequent parsing,
processing of individual IP addresses and summarized IP groups. Updates firewall address list and routing table.

Lib:

- librouteros: <https://librouteros.readthedocs.io/en/3.4.1/connect.html>

## URLS

- `/docs` Swagger/OpenAPI docs
- `/docs/openapi.json` Swagger/OpenAPI json file for export->import to external OpenApi viewer
- `/monitoring` - Prometheus FastAPI metrics

## Environments

Arguments / Environments

- `ROOT_PASS` - Password for SSH. Default: autogenerated(see in log output)
- `IS_PRODUCTION` - Default: `False`
- `HOST` - Listen on IP addr. Default: `127.0.0.1`
- `PORT` - Listen TCP port. Default: `4000`
- `LOG_LEVEL` - Logging level for app (not requests ib). Default: `debug`
- `DOMAINS_UPDATE_INTERVAL` - The interval since the date the domains was last processed. Do not take recently processed
  ones. Default: `172800` - 2 days
- `DB_FLUSH_BATCH_SIZE` - Maximum size of the number of processed domains to be written to the database. It is more
  efficient to write in batches. It is also important to realize that while the list is not written to the database, it
  is placed in the container memory. Default: `100`
- `THREADS_COUNT` - Maximum number of threads. Only slicing is used to process bundles creates threads greater than the
  set limit. Default = cpu=(cpus - 1) if cpus > 3 || cpu=1
- `QUEUE_SIZE` - Domains queue and DB queue size. Default: `100`
- `RESOLVE_DOMAINS_BATCH_SIZE` - Default: `50`
- `DB_EMPTY_ITER`
- `RESOLVE_EMPTY_ITER`

## RouterOS

```shell
/container/add remote-image=gregorygost/gost-rdpr:latest interface=LAN-VEth1 envlist=rdpr-envs hostname=gost-rdpr mounts=rdpr-db root-dir=container/gost-rdpr logging=yes comment=GOST-RDPR start-on-boot=yes
```

### Windows

View envs

```powershell
ls env:

$value = $env:HOST
Write-Host $value
```

Set permanent envs

```powershell
[System.Environment]::SetEnvironmentVariable('HOST', '0.0.0.0')
[System.Environment]::SetEnvironmentVariable('IS_PRODUCTION', 'False')
[System.Environment]::SetEnvironmentVariable('LOG_LEVEL', 'debug')
```

## Build docker images

Build docker image for RouterOS CHR and Arm device

```shell
docker buildx create --driver=docker-container --name build-container
docker buildx use build-container
# Build for amd64(x86_64) and arm64 without arguments
docker buildx build --no-cache --platform linux/amd64,linux/arm64 --output=type=docker --push -t gregorygost/gost-rdpr .
# Build for amd64(x86_64) and arm64 with arguments
docker buildx build --no-cache --platform linux/amd64,linux/arm64 --output=type=docker \
--build-arg IS_PRODUCTION='False' --build-arg HOST='0.0.0.0' --build-arg LOG_LEVEL='info' --push \
-t gregorygost/gost-rdpr .

# run docker after build
docker run -d -p 8080:4000 -e LOG_LEVEL='debug' --memory=1024m --cpus="1" --restart unless-stopped gregorygost/gost-rdpr
```

Try it open on <http://127.0.0.1:8080/docs>

Save docker image after build. In windows for gzip use 7zip application

```shell
docker images
docker save -o gost-rdpr.tar gregorygost/gost-rdpr
```

## Contrib

Create virtual env

```shell
python -m venv .venv
```

Activate venv

```powershell
.\.venv\Scripts\activate
```

```shell
source .venv/bin/activate
```

Upgrade pip

```shell
python -m pip install --upgrade pip
```

Install libs from requirements.txt

```shell
pip install -r requirements.txt
```

or manual install libs

```shell
pip install fastapi
pip install librouteros
pip install prometheus-fastapi-instrumentator
```

or upgrade libs

```shell
pip list -o
pip install [package_name] --upgrade
```

Freeze requirements

```shell
pip freeze > requirements.txt
```
